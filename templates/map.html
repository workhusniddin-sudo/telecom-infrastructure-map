<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢–µ–ª–µ–∫–æ–º –∫–∞—Ä—Ç–∞ ‚Äî –•—É–¥–∂–∞–Ω–¥ (ArcGIS Satellite + Leaflet)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <style>
    html,body { height:100%; margin:0; font-family: "Segoe UI", Tahoma, Verdana, sans-serif; background:#f5f5f5; }
    #map { width:100%; height:100vh; }
    /* Control panel */
    .control-panel{
      position:absolute; left:12px; top:12px; z-index:1100;
      width:380px; background:#fff; padding:16px; border-radius:12px;
      box-shadow:0 6px 24px rgba(0,0,0,0.12);
      max-height:88vh; overflow:auto;
    }
    .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .panel-header h2 { margin:0; font-size:1.2rem; color:#243447; }
    input[type=text], select { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ee; margin-bottom:8px; }
    .btn { display:inline-flex; align-items:center; gap:8px; background:#3498db; color:#fff; padding:9px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn:hover { transform:translateY(-1px) }
    .btn.small { padding:6px 8px; font-size:0.9rem }
    .legend { position:absolute; left:12px; bottom:12px; z-index:1100; background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.12); font-size:13px }
    .legend-item { display:flex; align-items:center; gap:8px; margin:6px 0 }
    .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; background:#2f3b46; color:#fff; padding:8px; border-radius:8px; font-size:13px }
    .stat-value { font-weight:700; font-size:1.05rem; color:#7bd389 }
    .floating-actions { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
    /* small helpers */
    .muted { color:#6b7280; font-size:0.95rem }
    .draw-export { margin-top:10px; display:flex; gap:8px }
    pre#geojsonOut { max-height:150px; overflow:auto; background:#f7f7f7; padding:8px; border-radius:6px; font-size:12px }
  </style>
</head>
<body>

  <div class="control-panel">
    <div class="panel-header">
      <h2><i class="fas fa-network-wired"></i> –¢–µ–ª–µ–∫–æ–º ‚Äî –•—É–¥–∂–∞–Ω–¥</h2>
      <div class="muted">ArcGIS Satellite + Leaflet</div>
    </div>

    <div>
      <input id="addressInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏" />
      <div style="display:flex; gap:8px; margin-top:6px">
        <button class="btn" onclick="checkConnection()"><i class="fas fa-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn small" onclick="locateMe()"><i class="fas fa-crosshairs"></i> –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        <button class="btn small" onclick="loadMapData()"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <label class="muted">–§–∏–ª—å—Ç—Ä—ã</label>
      <div style="display:flex; gap:8px; margin-top:6px">
        <select id="objectTypeFilter" onchange="loadMapData()">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="olt">OLT</option>
          <option value="splice_box">–ú—É—Ñ—Ç–∞</option>
          <option value="splitter">–°–ø–ª–∏—Ç—Ç–µ—Ä</option>
          <option value="switch">–ö–æ–º–º—É—Ç–∞—Ç–æ—Ä</option>
          <option value="ats">–ê–¢–°</option>
        </select>
        <select id="technologyFilter" onchange="loadMapData()">
          <option value="">–í—Å–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
          <option value="gpon">GPON</option>
          <option value="adsl">ADSL</option>
          <option value="ethernet">Ethernet</option>
        </select>
      </div>
    </div>

    <div class="stat-grid" id="stats" style="margin-top:12px">
      <div><div class="stat-value" id="statObjects">0</div>–û–±—ä–µ–∫—Ç–æ–≤</div>
      <div><div class="stat-value" id="statFreePorts">0</div>–°–≤–æ–±–æ–¥–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤</div>
    </div>

    <div style="margin-top:10px">
      <div class="floating-actions">
        <button class="btn small" id="toggleLabelsBtn" onclick="toggleLabels()"><i class="fas fa-tags"></i> –ü–µ—Ä–µ–∫–ª. –ø–æ–¥–ø–∏—Å–µ–π</button>
        <button class="btn small" onclick="exportDrawn()"><i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç GeoJSON</button>
        <button class="btn small" onclick="clearDrawn()"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–µ</button>
      </div>
      <div style="margin-top:8px" id="result" class="muted">–ì–æ—Ç–æ–≤–æ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã.</div>
    </div>

  </div>

  <div class="legend" id="legend">
    <div style="font-weight:700; margin-bottom:6px">–õ–µ–≥–µ–Ω–¥–∞</div>
    <div class="legend-item"><span style="color:#e74c3c">‚óè</span> OLT</div>
    <div class="legend-item"><span style="color:#3498db">‚óè</span> –ú—É—Ñ—Ç–∞</div>
    <div class="legend-item"><span style="color:#27ae60">‚óè</span> –°–ø–ª–∏—Ç—Ç–µ—Ä</div>
    <div class="legend-item"><span style="color:#f39c12">‚óè</span> –ö–æ–º–º—É—Ç–∞—Ç–æ—Ä</div>
  </div>

  <div id="map"></div>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
  /****************************************************************
   * Enhanced map: ArcGIS Satellite + OSM, labels, clusters, draw
   ****************************************************************/

  // --- init map (centered on –•—É–¥–∂–∞–Ω–¥) ---
  var map = L.map('map', {
    center: [40.291, 69.622],
    zoom: 14,
    minZoom: 4
  });

  // --- base layers ---
  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  });

  var arcgisSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, Maxar'
  }).addTo(map); // satellite as default

  // --- labels overlay (ArcGIS reference layer with place names/labels) ---
  var arcgisLabels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    attribution: 'Labels ¬© Esri'
  });

  var baseMaps = {
    "üõ∞ –°–ø—É—Ç–Ω–∏–∫ (ArcGIS)": arcgisSatellite,
    "üó∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (OSM)": osm
  };

  var overlayMaps = {
    "–ü–æ–¥–ø–∏—Å–∏ (ArcGIS Labels)": arcgisLabels
  };

  L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

  // --- marker clusters per type (so we can toggle types individually) ---
  var markerClusters = {};   // key: object_type -> L.MarkerClusterGroup
  var allClustersGroup = L.layerGroup().addTo(map); // convenience group

  var cableRoutesLayer = L.layerGroup().addTo(map); // polylines layer

  // types colors & SVG icons (HD)
  var typeConfig = {
    'olt': { color:'#e74c3c', label:'OLT' },
    'splice_box': { color:'#3498db', label:'–ú—É—Ñ—Ç–∞' },
    'splitter': { color:'#27ae60', label:'–°–ø–ª–∏—Ç—Ç–µ—Ä' },
    'switch': { color:'#f39c12', label:'–ö–æ–º–º—É—Ç–∞—Ç–æ—Ä' },
    'ats': { color:'#9b59b6', label:'–ê–¢–°' },
    'building': { color:'#95a5a6', label:'–î–æ–º' },
    'client': { color:'#34495e', label:'–ö–ª–∏–µ–Ω—Ç' }
  };

  function makeSvgIcon(color, letter) {
    // simple circular SVG marker with letter
    var svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 42 42">
        <circle cx="21" cy="18" r="12" fill="${color}" stroke="#fff" stroke-width="2"/>
        <text x="21" y="23" font-size="12" font-family="Arial" font-weight="700" fill="#ffffff" text-anchor="middle">${letter||''}</text>
        <path d="M21 30 L17 42 L25 42 Z" fill="${color}"/>
      </svg>
    `);
    return L.icon({
      iconUrl: 'data:image/svg+xml;charset=utf-8,' + svg,
      iconSize: [28, 42],
      iconAnchor: [14, 42],
      popupAnchor: [0, -36],
      className: ''
    });
  }

  // Pre-create cluster groups and add to layer control (will be filled later)
  Object.keys(typeConfig).forEach(function(t) {
    markerClusters[t] = L.markerClusterGroup({ chunkedLoading: true, maxClusterRadius: 50 });
    // add to overlays so user can toggle type visibility
    overlayMaps[typeConfig[t].label + ' (—Å–ª–æ–π)'] = markerClusters[t];
  });

  // re-add layer control (we need dynamic overlays initialized)
  // remove previous control then add with updated overlayMaps
  document.querySelectorAll('.leaflet-control-layers').forEach(e => e.remove());
  L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

  // Helper: format popup HTML
  function makePopupHtml(obj) {
    return `
      <div style="min-width:200px">
        <div style="font-weight:700; margin-bottom:6px;">${obj.name}</div>
        <div style="font-size:13px">
          <b>ID:</b> ${obj.object_id}<br/>
          <b>–¢–∏–ø:</b> ${obj.object_type_display || obj.object_type}<br/>
          <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:</b> ${obj.technology_display || obj.technology || '‚Äî'}<br/>
          <b>–ü–æ—Ä—Ç—ã:</b> ${obj.free_ports}/${obj.capacity}<br/>
          <b>–ê–¥—Ä–µ—Å:</b> ${obj.address || '‚Äî'}
        </div>
      </div>
    `;
  }

  // Load data and populate map
  function loadMapData() {
    showResult('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
    showLoading(true);

    const objectType = document.getElementById('objectTypeFilter').value;
    const technology = document.getElementById('technologyFilter').value;
    let url = '/api/map-data/';
    const params = new URLSearchParams();
    if (objectType) params.append('object_type', objectType);
    if (technology) params.append('technology', technology);
    if (params.toString()) url += '?' + params.toString();

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + r.status);
        return r.json();
      })
      .then(data => {
        clearMap();
        // objects
        (data.infrastructure_objects || []).forEach(obj => {
          const t = obj.object_type || 'building';
          const cfg = typeConfig[t] || { color:'#95a5a6', label:t };
          const letter = (cfg.label || t).slice(0,1).toUpperCase();
          const icon = makeSvgIcon(cfg.color, letter);

          const m = L.marker([obj.lat, obj.lng], { icon: icon })
            .bindPopup(makePopupHtml(obj));

          // store distance if present (for highlight)
          m._meta = { id: obj.id, objectData: obj };

          if (!markerClusters[t]) {
            markerClusters[t] = L.markerClusterGroup({ chunkedLoading:true });
            overlayMaps[cfg.label + ' (—Å–ª–æ–π)'] = markerClusters[t];
          }
          markerClusters[t].addLayer(m);
        });

        // add clusters to map (if not already)
        Object.keys(markerClusters).forEach(k => {
          if (!map.hasLayer(markerClusters[k])) {
            markerClusters[k].addTo(map);
          }
        });

        // cable routes
        (data.cable_routes || []).forEach(route => {
          if (route.from_object && route.to_object) {
            const latlngs = [
              [route.from_object.lat, route.from_object.lng],
              [route.to_object.lat, route.to_object.lng]
            ];
            var poly = L.polyline(latlngs, { color:'#2a9df4', weight:3, opacity:0.8 }).bindPopup(
              `<div style="font-weight:700">${route.name}</div><div>${route.length} –º</div>`
            );
            cableRoutesLayer.addLayer(poly);
          }
        });

        // add cableRoutes layer to overlays so users can toggle
        if (!overlayMaps["–ö–∞–±–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã"]) {
          overlayMaps["–ö–∞–±–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã"] = cableRoutesLayer;
          // re-create control to include new overlay
          document.querySelectorAll('.leaflet-control-layers').forEach(e => e.remove());
          L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
        }

        updateStats();
        showResult('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
      })
      .catch(err => {
        console.error(err);
        showResult('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã: ' + err.message, 'error');
      })
      .finally(() => { showLoading(false); });
  }

  // --- locate me ---
  function locateMe() {
    showResult('–û–ø—Ä–µ–¥–µ–ª—è—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...');
    map.locate({ setView:true, maxZoom:16, watch:false });
  }
  map.on('locationfound', function(e){
    L.circle(e.latlng, { radius: Math.max(e.accuracy, 20), color:'#2ecc71', weight:1, fillOpacity:0.1 }).addTo(map);
    showResult('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ', 'success');
  });
  map.on('locationerror', function(){
    showResult('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
  });

  // toggle labels overlay
  var labelsVisible = false;
  function toggleLabels(){
    labelsVisible = !labelsVisible;
    if (labelsVisible) {
      arcgisLabels.addTo(map);
      document.getElementById('toggleLabelsBtn').innerText = '–û—Ç–∫–ª. –ø–æ–¥–ø–∏—Å–∏';
    } else {
      map.removeLayer(arcgisLabels);
      document.getElementById('toggleLabelsBtn').innerText = '–ü–µ—Ä–µ–∫–ª. –ø–æ–¥–ø–∏—Å–µ–π';
    }
  }

  // check connection (uses your API)
  function checkConnection(){
    var q = document.getElementById('addressInput').value.trim();
    if (!q) { showResult('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error'); return; }
    showResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
    showLoading(true);
    fetch('/api/check-connection/?address=' + encodeURIComponent(q))
      .then(r => r.json())
      .then(data=>{
        if (data.available) {
          showResult(data.message, 'success');
        } else {
          showResult(data.message, 'error');
        }
        // highlight nearest if present
        if (data.nearest_objects && data.nearest_objects.length) highlightNearest(data.nearest_objects);
      })
      .catch(err=>{
        console.error(err);
        showResult('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
      })
      .finally(()=>showLoading(false));
  }

  // highlight nearest objects (simple)
  function highlightNearest(list) {
    // add temporary markers
    list.forEach(o=>{
      var m = L.circleMarker([o.lat, o.lng], { radius:10, color:'#f1c40f', fillColor:'#f1c40f', weight:2, fillOpacity:0.9 }).addTo(map);
      m.bindPopup(`<b>${o.name}</b><br>–ü–æ—Ä—Ç—ã: ${o.free_ports}/${o.capacity}`).openPopup();
      setTimeout(()=>map.removeLayer(m), 8000);
    });
  }

  // --- stats ---
  function updateStats(){
    fetch('/api/infrastructure/stats/')
      .then(r=>r.json())
      .then(s=>{
        document.getElementById('statObjects').innerText = s.total_objects || 0;
        document.getElementById('statFreePorts').innerText = s.total_free_ports || 0;
      })
      .catch(e=>console.warn('stats err', e));
  }

  // --- clear map layers ---
  function clearMap(){
    // remove clusters
    Object.keys(markerClusters).forEach(k=>{
      try { markerClusters[k].clearLayers(); } catch(e) {}
    });
    // remove cable routes
    cableRoutesLayer.clearLayers();
  }

  function showLoading(flag){
    var el = document.getElementById('result');
    el.style.opacity = flag ? 0.6 : 1;
  }

  function showResult(msg, type){
    var el = document.getElementById('result');
    el.innerText = msg;
    if (type==='success') el.style.color = '#16a34a';
    else if (type==='error') el.style.color = '#dc2626';
    else el.style.color = '#374151';
  }

  /*******************
   * Drawing / editing (Leaflet.draw)
   *******************/
  var drawnItems = new L.FeatureGroup().addTo(map);

  var drawControl = new L.Control.Draw({
    position: 'topright',
    draw: {
      polygon: false,
      rectangle: false,
      circle: false,
      marker: false,
      circlemarker: false,
      polyline: {
        shapeOptions: { color: '#ff7b00', weight: 4 }
      }
    },
    edit: {
      featureGroup: drawnItems,
      remove: true
    }
  });
  map.addControl(drawControl);

  // When user finishes drawing, open prompt to name and optionally POST to server
  map.on(L.Draw.Event.CREATED, function (e) {
    var layer = e.layer;
    drawnItems.addLayer(layer);
    // Ask user for metadata (simple prompt)
    var name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞—Å—Å—ã (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ):", "");
    if (name) {
      layer.bindPopup("<b>" + escapeHtml(name) + "</b>").openPopup();
    }
    // Save geometry as GeoJSON attached to layer
    layer.feature = layer.feature || {};
    layer.feature.type = "Feature";
    layer.feature.properties = layer.feature.properties || {};
    layer.feature.properties.name = name || '';
  });

  map.on('draw:edited', function(e){
    showResult('–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ ' + e.layers.getLayers().length + ' –æ–±—ä–µ–∫—Ç–æ–≤', 'success');
  });

  // Export drawn items to GeoJSON (download & console)
  function exportDrawn(){
    var geojson = drawnItems.toGeoJSON();
    var text = JSON.stringify(geojson, null, 2);
    // Open in new window for copy
    var w = window.open("", "_blank");
    w.document.write("<pre>" + escapeHtml(text) + "</pre>");
    // Example: POST to backend (uncomment & adjust endpoint if you have API)
    /*
    fetch('/api/cable-routes/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: text
    }).then(r=>r.json()).then(console.log).catch(console.error);
    */
  }

  function clearDrawn(){
    drawnItems.clearLayers();
    showResult('–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
  }

  function escapeHtml(unsafe) {
    return unsafe ? unsafe.replace(/[&<"'>]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; }) : '';
  }

  // --- initial load ---
  loadMapData();

  // ensure map resizes correctly if control panel changes
  setTimeout(()=>map.invalidateSize(), 300);

  </script>
</body>
</html>
